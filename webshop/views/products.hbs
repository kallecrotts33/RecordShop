<div class="container mt-5 text-center bg-light p-4 rounded">
    <h1>Products</h1>
    <p>These are the products in stock</p>

    <div class="mb-4">
        <input type="text" id="searchBar" class="form-control w-50 mx-auto" placeholder="Search records...">
    </div>
    <div class=" gap-3">
        <select id="artistFilter" class="form-select w-50 mx-auto mb-2">
            <option value="">Filter by artist</option>
            {{#each artists}}
            <option value="{{artist_name}}">{{artist_name}}</option>
            {{/each}}
        </select>
        <select id="genreFilter" class="form-select w-50 mx-auto mb-4">
            <option value="">Filter by genre</option>
            {{#each genres}}
            <option value="{{genre_name}}">{{genre_name}}</option>
            {{/each}}
        </select>
    </div>
    <div class=" text-start">
        <label for="itemsPerPage" class="form-label">Items per page:</label>
        <select id="itemsPerPage" class="form-select w-25 d-inline-block ms-2 ">
            <option value="4">4</option>
            <option value="8">8</option>
            <option value="12">12</option>
        </select>
    </div>

    <div id="recordGrid" class="row mt-1">
        {{#if records.length}}
        {{#each records}}
        <div class="col-md-6 mb-5 record-card">
            <div class="card h-100">

                <div id="carousel-{{record_id}}" class="carousel slide mx-auto mt-3" data-bs-interval="false"
                    style="max-width:400px;">

                    <div class="carousel-inner">
                        {{#each image_src}}
                        <div class="carousel-item {{#if @first}}active{{/if}}">
                            <img src="/images/{{this}}.jpg" class="d-block w-100 rounded-3"
                                alt="{{../record_title}} image {{@index}}"
                                onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
                        </div>
                        {{/each}}
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{record_id}}"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>

                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{record_id}}"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>

                <div class="card-body text-center mt-3">
                    <h5 class="card-title fw-bold text-primary">{{record_title}}</h5>
                    <p class="card-text-artist fs-5 fw-semibold mb-3">{{artist_name}}</p>
                    <p class="card-text-genre fw-semibold mb-3">{{genre_name}}</p>
                    <p class="card-text-price fs-5 fw-semibold text-success mb-3">{{price}}â‚¬</p>

                    <button class="btn btn-outline-primary w-100 add-to-cart" data-id="{{record_id}}">Add to
                        Cart</button>
                    <button class="btn btn-outline-success w-100 mt-2 info-btn" data-id="{{record_id}}">Info</button>
                </div>

            </div>
        </div>
        {{/each}}
        {{else}}
        <p class="text-danger">Sorry! We are out of stock.</p>
        {{/if}}
    </div>

    <div id="pagination" class="d-flex justify-content-center mt-4 gap-2"></div>
</div>


<script>
    // Pagiation and Filtering Logic
    const ITEMS_PER_PAGE = 4;
    let currentPage = 1;
    let allCards = [];
    let filteredCards = [];
    let itemsPerPage = 4;

    document.addEventListener("DOMContentLoaded", () => {
        allCards = Array.from(document.querySelectorAll("#recordGrid .record-card"));
        const itemsPerPageSelect = document.getElementById("itemsPerPage");
        itemsPerPageSelect.addEventListener("change", (e) => {
            itemsPerPage = parseInt(e.target.value);
            displayPage(1);
        });
        displayPage(1);
    });

    function displayPage(page) {
        currentPage = page;
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        allCards.forEach(card => {
            card.style.display = "none";
        });

        filteredCards.slice(start, end).forEach(card => {
            card.style.display = "block";
        });

        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn ${i === currentPage ? "btn-primary" : "btn-outline-primary"}`;
            btn.innerText = i;
            btn.addEventListener("click", () => displayPage(i));
            paginationDiv.appendChild(btn);
        }
    }

    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("info-btn")) {
            const id = e.target.dataset.id;
            window.location.href = `/recordInfo?id=${id}`;
        }
        if (e.target.classList.contains("add-to-cart")) {
            const id = e.target.dataset.id;
            const cart = JSON.parse(sessionStorage.getItem("cart")) || {};
            if (cart[id]) {
                cart[id] += 1;
            } else {
                cart[id] = 1;
            }
            sessionStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
        }
    });

    const searchInput = document.getElementById("searchBar");
    const artistFilter = document.getElementById("artistFilter");
    const genreFilter = document.getElementById("genreFilter");
    const itemsPerPageSelect = document.getElementById("itemsPerPage");

    function filterRecords() {
        const searchValue = searchInput.value.toLowerCase();
        const selectedArtist = artistFilter.value.toLowerCase();
        const selectedGenre = genreFilter.value.toLowerCase();

        filteredCards = allCards.filter(card => {
            const title = card.querySelector(".card-title").innerText.toLowerCase();
            const artist = card.querySelector(".card-text-artist").innerText.toLowerCase();
            const genre = card.querySelector(".card-text-genre").innerText.toLowerCase();

            return (
                (title.includes(searchValue)) &&
                (!selectedArtist || artist === selectedArtist) &&
                (!selectedGenre || genre === selectedGenre)
            );
        });

        displayPage(1);
    }

    searchInput.addEventListener("input", filterRecords);
    artistFilter.addEventListener("change", filterRecords);
    genreFilter.addEventListener("change", filterRecords);

    itemsPerPageSelect.addEventListener("change", (e) => {
        ITEMS_PER_PAGE = parseInt(e.target.value);
        displayPage(1);
    });

    // Initialize filteredCards
    window.addEventListener("load", () => {
        filteredCards = allCards;
        displayPage(1);
    });
</script>
</antml>